(function(c){var b="ajaxImageUpload",d={fileInput:"",ajaxUrl:"",imageUrl:[],ajaxData:{},allowZoom:true,allowType:["gif","jpeg","jpg","bmp","png"],maxNum:5,maxSize:1,appendMethod:"before",before:c.noop,success:c.noop,error:c.noop,complete:c.noop};function a(f,e){this.element=f;this.settings=c.extend({},d,e);this._defaults=d;this._name=b;this.complete=true;this.code=0;this.msg="";this.init()}a.prototype={init:function(){var g=this,f=c(this.element),e=g.settings.imageUrl;g.createSectionBox();if(e.length>0){for(var h=0;h<e.length;h++){g.createImageSection(e[h])}}f.find("input[type=file]").on("change",function(){g.selectFile()})},selectFile:function(){var n=this,k=c(this.element),m=n.settings.maxNum,h=n.settings.maxSize,q=n.settings.ajaxUrl,i=n.settings.fileInput,j=n.settings.before,l=n.settings.complete,o=k.find("input[type=file]"),g=k.find(".ggy-image-section");if(!q){n.callError("300","没有配置ajaxUrl");n.resetFile();return false}if(!i){n.callError("301","没有配置fileInput");n.resetFile();return false}if(j&&j()===false){n.resetFile();return false}var e=o[0].files;if(e.length+g.length>m){n.callError("302","上传图片数目不能超过"+m+"个");n.resetFile();return false}for(var p=0;p<e.length;p++){var f=e[p];if(!n.isAllowFile(f)){n.callError("303",f.name+" 图片类型不支持");n.resetFile();break}if(n.getFileSize(f)>h){n.callError("304","上传图片不能超过"+h+"M，当前上传图片的大小为"+$fileSize.toFixed(2)+"M");n.resetFile();break}n.createImageSection();n.ajaxUpload(f)}if(n.complete==true){l()}n.resetFile()},createSectionBox:function(){var k=this,j=c(this.element),f=k.settings.fileInput,e=c("<div class='ggy-section-box'></div>"),l=c("<section class='ggy-upload-section'></section>"),i=c("<section class='ggy-modal-section'></section>"),h=c("<i class='ggy-upload-icon'></i>"),g=c("<input type='file' name='"+f+"' class='ggy-upload-input' accept='image/*' multiple='multiple'>");e.appendTo(j);l.appendTo(e);h.appendTo(l);g.appendTo(l);i.appendTo(e);i.on("click",function(m){m.stopPropagation();i.hide()})},createImageSection:function(j){var m=this,l=c(this.element),i=m.settings.fileInput,n=m.settings.allowZoom,o=m.settings.appendMethod,f=l.find(".ggy-section-box"),k=l.find(".ggy-upload-section"),g=c("<section class='ggy-image-section loading'></section>"),p=c("<div class='ggy-image-shade'></div>"),e=c("<input type='hidden' name='"+i+"[]' value='"+j+"'>"),h=c("<img class='ggy-image-show shade' src='"+j+"'/>");if(j){h=c("<img class='ggy-image-show' src='"+j+"'/>")}switch(o){case"before":f.prepend(g);break;case"after":k.before(g);break}e.appendTo(g);h.appendTo(g);p.appendTo(g);m.createDeleteNode(g);if(j&&n===true){m.createZoomNode(g)}},createDeleteNode:function(f){var i=c(this.element),h=i.find(".ggy-modal-section"),e=c("<i class='ggy-delete-icon'></i>"),g=c("<div class='ggy-modal-box ggy-delete-box'><p class='ggy-delete-tip'>您确定要删除吗？</p><p class='ggy-delete-btn'> <span class='ggy-confirm-btn'>确定</span><span class='ggy-cancel-btn'>取消</span></p></div>");e.appendTo(f);f.find(".ggy-delete-icon").on("click",function(j){j.stopPropagation();h.html(g);h.show()});g.find(".ggy-confirm-btn").on("click",function(j){j.stopPropagation();h.hide();f.remove();g.remove()});g.find(".ggy-cancel-btn").on("click",function(j){j.stopPropagation();h.hide();return false})},createZoomNode:function(g){var i=c(this.element),e=g.find(".ggy-image-show"),h=i.find(".ggy-modal-section"),j=c("<i class='ggy-zoom-icon'></i>"),f=c("<div class='ggy-modal-box ggy-zoom-box'><img src=''/></div>");f.find("img").attr("src",e.attr("src"));j.appendTo(g);g.find(".ggy-zoom-icon").on("click",function(k){k.stopPropagation();h.html(f);h.show()})},ajaxUpload:function(e){var n=this,l=c(this.element),h=n.settings.fileInput,m=n.settings.ajaxData,q=n.settings.ajaxUrl,p=n.settings.allowZoom,i=n.settings.success,o=n.settings.appendMethod;switch(o){case"before":var f=l.find(".ggy-image-section:first");var g=l.find(".ggy-image-show:first");break;case"after":var f=l.find(".ggy-image-section:last");var g=l.find(".ggy-image-show:last");break}var k=new FormData();k.append(h,e);for(var j in m){k.append(j,m[j])}c.ajax({url:q,type:"post",async:false,data:k,processData:false,contentType:false,dataType:"json",mimeType:"multipart/form-data",success:function(r){if(r.code!=200){n.callError(r.code,r.msg);f.remove();return false}g.removeClass("shade").attr("src",r.src);f.find("input[type=hidden]").val(r.src);if(p===true){n.createZoomNode(f)}n.complete*=true;i(r)},error:function(r,t,s){n.callError(r.status,"AjaxUrl Service Error:"+r.statusText);f.remove()}})},isAllowFile:function(f){var g=this.settings.allowType,e=this.getFileExt(f);if(c.inArray(e,g)!=-1){return true}return false},getFileExt:function(f){var g=f.name,e=g.lastIndexOf(".");if(e<1){return""}return g.substr(e+1).toLowerCase()},getFileSize:function(e){return(e.size)/(1024*1024)},resetFile:function(){c(this.element).find("input[type=file]").val(null)},callError:function(g,f){var h=this,e=h.settings.error;h.complete*=false;h.code=g;h.msg=f;e(h)}};c.fn[b]=function(e){return this.each(function(){if(!c.data(this,"plugin_"+b)){c.data(this,"plugin_"+b,new a(this,e))}})}})(jQuery,window,document);
